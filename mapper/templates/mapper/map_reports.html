{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div>    
    <div id="map">

        {% comment %} Toggle map style button {% endcomment %}
        <button id="toggle-satellite">
            <img id="toggle-icon" src="{% static 'images/satellite_icon.png' %}" alt="Satellite Icon">
            <span id="toggle-text">Satellite View</span>
        </button>

        {% comment %} Button to add new report {% endcomment %}
        <button id="add-report">
            <img src="{% static 'images/marker.png' %}" alt="Add Report Icon">
        </button>

        <!-- Google Logo -->
        <div id="google-logo">
            <img src={% static 'images/google_on_non_white_hdpi.png' %} alt="Google Logo" style="height:20px;">
        </div>
    </div>

    <div class="map-report-form-container">
        <button id="close-form" class="close-btn" aria-label="Close">&times;</button>
        <form method="post" enctype="multipart/form-data" id="map-report-form" 
            action="{% url 'map-reports' %}" 
            hx-post="{% url 'map-reports' %}" 
            hx-target="#new-report-container" 
            hx-swap="beforeend">
            {% csrf_token %}
            {% crispy form %}
        </form>
        <div id="form-errors" class="text-danger"></div> <!-- Placeholder for form errors -->
    </div>

    <div id="submission-success-container">
        {% for message in messages %}
        <div class="{{ message.tags }}" id="msg" role="alert">
            {{ message|safe }}
        </div>
        {% endfor %}
    </div>

    <!-- Embed the reports data safely using json_script -->
    {{ reports|json_script:"reports-data" }}

    {% comment %} Container for new report data {% endcomment %}
    <div id="new-report-container">
    </div>
</div>

<!-- Maplibre GL JS -->
<script src="https://unpkg.com/maplibre-gl@^5.3.0/dist/maplibre-gl.js"></script>
<!-- Ordnance Survey -->
<script src="https://cdn.jsdelivr.net/gh/OrdnanceSurvey/os-api-branding@0.3.1/os-api-branding.js"></script>
{% comment %} turf.js for checking clicked locations are inside UK boundary {% endcomment %}
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
 <!-- Define JS variables with the static URLs -->
<script>

    const satelliteIconUrl = "{% static 'images/satellite_icon.png' %}";
    const mapIconUrl = "{% static 'images/map_icon.png' %}";
    const markerUrl = "{% static 'images/marker_32_48.png' %}";
</script>
<script type="module" src="{% static 'js/map-reports.js' %}"></script>
<script src="{% static 'js/add-event-listener-new-report-marker.js' %}"></script>
{% endblock %}